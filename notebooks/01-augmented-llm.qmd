---
title: "Pattern 1: Augmented LLM"
subtitle: "Source Verification and Credibility Checking"
author: "Rui Barros"
format:
  html:
    code-fold: show
    code-tools: true
execute:
  eval: false
---

## Pattern Overview

::: {.callout-note icon=false}
## What is an Augmented LLM?
An **Augmented LLM** is a base language model enhanced with access to external tools, databases, or APIs. Instead of relying solely on its training data, it can retrieve real-time information, verify facts, and access specialized knowledge sources.
:::

### Core Concept

```{mermaid}
%%| fig-width: 10
graph LR
    A[User Query] --> B[LLM]
    B --> C{Needs External Info?}
    C -->|Yes| D[Tool Selection]
    C -->|No| H[Direct Response]
    D --> E[Execute Tool]
    E -->|Database Query| F1[Government DB]
    E -->|Web Search| F2[News Archive]
    E -->|API Call| F3[Fact-Check API]
    F1 --> G[Tool Results]
    F2 --> G
    F3 --> G
    G --> B
    B --> H
```

**Key Features:**
- Base LLM + External tools
- Real-time data access
- Verifiable sources
- Structured retrieval

## Journalism Use Case: Source Verification

### The Challenge

A politician claims: *"Unemployment decreased by 15% in the last quarter."*

**Questions to verify:**
1. Is this claim accurate?
2. What are the official statistics?
3. Has this been reported elsewhere?
4. What's the context (seasonal adjustment, methodology)?

### Traditional Approach

Manual process:
1. Search government statistics portal
2. Check news archives
3. Review expert commentary
4. Cross-reference with historical data
5. Verify calculation methodology

**Estimated time**: 1-2 hours

### Augmented LLM Approach

The agent automatically:
1. Queries official statistics API
2. Searches news archives
3. Retrieves expert analyses
4. Compares methodologies
5. Generates verified report with citations

**Estimated time**: 2-3 minutes

## Architecture Breakdown

### Components

```{mermaid}
%%| fig-width: 10
graph TB
    subgraph "Augmented LLM System"
        A[User Input:<br/>Claim to Verify] --> B[LLM Core]
        B --> C{Select Tool}

        C -->|Statistics| D[Gov Stats API]
        C -->|News| E[News Archive Search]
        C -->|Academic| F[Research DB]
        C -->|Fact-Check| G[Fact-Check DB]

        D --> H[Parse & Structure]
        E --> H
        F --> H
        G --> H

        H --> B
        B --> I[Generate Report]
        I --> J[Verified Claim<br/>+ Sources]
    end
```

### Tool Types

| Tool Category | Purpose | Example |
|--------------|---------|---------|
| **Data Sources** | Retrieve official statistics | Census API, Economic indicators |
| **Search** | Find relevant articles/documents | News archive, Google Scholar |
| **Verification** | Check against known facts | Fact-checking databases |
| **Analysis** | Process retrieved data | Statistical validation |

## Implementation Example

### Conceptual Code Structure

::: {.panel-tabset}

#### Python

```python
import anthropic
import os
from typing import List, Dict
import requests

class SourceVerificationAgent:
    """Augmented LLM for verifying claims with external sources."""

    def __init__(self, api_key: str):
        self.client = anthropic.Anthropic(api_key=api_key)
        self.tools = [
            {
                "name": "search_government_statistics",
                "description": "Search official government statistics databases for economic and social indicators",
                "input_schema": {
                    "type": "object",
                    "properties": {
                        "query": {"type": "string", "description": "Search query"},
                        "category": {"type": "string", "description": "Category: employment, economy, demographics"}
                    },
                    "required": ["query"]
                }
            },
            {
                "name": "search_news_archives",
                "description": "Search news archives for previous reporting on similar claims",
                "input_schema": {
                    "type": "object",
                    "properties": {
                        "query": {"type": "string", "description": "Search query"},
                        "date_range": {"type": "string", "description": "Date range: last_week, last_month, last_year"}
                    },
                    "required": ["query"]
                }
            },
            {
                "name": "verify_calculation",
                "description": "Verify mathematical calculations in claims",
                "input_schema": {
                    "type": "object",
                    "properties": {
                        "claim": {"type": "string", "description": "The numerical claim to verify"},
                        "baseline": {"type": "number", "description": "Starting value"},
                        "current": {"type": "number", "description": "Current value"}
                    },
                    "required": ["claim", "baseline", "current"]
                }
            }
        ]

    def verify_claim(self, claim: str) -> Dict:
        """
        Verify a claim using augmented LLM with external tools.

        Args:
            claim: The claim to verify

        Returns:
            Dictionary with verification results and sources
        """
        messages = [{
            "role": "user",
            "content": f"""Verify this claim and provide sources:

"{claim}"

Use available tools to:
1. Search for official statistics
2. Check news archives for previous reporting
3. Verify any calculations
4. Provide a clear verdict with confidence level
"""
        }]

        response = self.client.messages.create(
            model="claude-3-5-sonnet-20241022",
            max_tokens=4096,
            tools=self.tools,
            messages=messages
        )

        # Process tool calls and gather evidence
        evidence = []
        for block in response.content:
            if block.type == "tool_use":
                tool_result = self._execute_tool(block.name, block.input)
                evidence.append({
                    "tool": block.name,
                    "input": block.input,
                    "result": tool_result
                })

                # Continue conversation with tool results
                messages.append({"role": "assistant", "content": response.content})
                messages.append({
                    "role": "user",
                    "content": [{
                        "type": "tool_result",
                        "tool_use_id": block.id,
                        "content": str(tool_result)
                    }]
                })

        # Get final response
        final_response = self.client.messages.create(
            model="claude-3-5-sonnet-20241022",
            max_tokens=4096,
            tools=self.tools,
            messages=messages
        )

        return {
            "verdict": final_response.content[0].text,
            "evidence": evidence,
            "sources_checked": len(evidence)
        }

    def _execute_tool(self, tool_name: str, tool_input: Dict) -> str:
        """Execute a tool and return results."""

        if tool_name == "search_government_statistics":
            # In real implementation, call actual API
            return self._search_gov_stats(tool_input)

        elif tool_name == "search_news_archives":
            # In real implementation, call news API
            return self._search_news(tool_input)

        elif tool_name == "verify_calculation":
            # Verify mathematical claims
            return self._verify_math(tool_input)

        return "Tool not found"

    def _search_gov_stats(self, params: Dict) -> str:
        """
        Search government statistics.
        In production: Connect to real API (e.g., Census Bureau, National Statistics Office)
        """
        # Simulated response for demonstration
        return """
        Official Statistics (Q4 2024):
        - Unemployment Rate Q3 2024: 5.2%
        - Unemployment Rate Q4 2024: 4.8%
        - Change: -0.4 percentage points (-7.7% decrease)
        - Source: National Bureau of Statistics
        - Methodology: Seasonally adjusted
        - Publication Date: 2024-12-01
        """

    def _search_news(self, params: Dict) -> str:
        """
        Search news archives.
        In production: Connect to news API or archive
        """
        return """
        News Archive Results (3 articles found):

        1. "Employment figures show modest improvement" - Financial Times (Dec 2)
           - Reports 0.4pp decrease in unemployment
           - Attributes to seasonal hiring

        2. "Labor market remains stable" - Reuters (Dec 1)
           - Confirms government statistics
           - Notes 7.7% decrease calculation

        3. "Experts question unemployment methodology" - Economic Journal (Nov 30)
           - Raises concerns about seasonal adjustment
           - Suggests real decrease may be smaller
        """

    def _verify_math(self, params: Dict) -> str:
        """Verify mathematical calculations."""
        baseline = params.get("baseline", 0)
        current = params.get("current", 0)

        if baseline == 0:
            return "Cannot calculate percentage change from zero baseline"

        percentage_change = ((current - baseline) / baseline) * 100

        return f"""
        Mathematical Verification:
        - Baseline: {baseline}%
        - Current: {current}%
        - Absolute Change: {current - baseline} percentage points
        - Percentage Change: {percentage_change:.1f}%
        - Claim verification: See analysis above
        """


# Usage Example
def main():
    agent = SourceVerificationAgent(
        api_key=os.getenv("ANTHROPIC_API_KEY")
    )

    claim = "Unemployment decreased by 15% in the last quarter"

    result = agent.verify_claim(claim)

    print("=" * 60)
    print("CLAIM VERIFICATION REPORT")
    print("=" * 60)
    print(f"\nClaim: {claim}\n")
    print(result["verdict"])
    print(f"\n\nSources Checked: {result['sources_checked']}")
    print("\nEvidence Gathered:")
    for i, evidence in enumerate(result["evidence"], 1):
        print(f"\n{i}. {evidence['tool']}")
        print(f"   Query: {evidence['input']}")


if __name__ == "__main__":
    main()
```

#### JavaScript

```javascript
// Similar implementation in JavaScript using Anthropic SDK
import Anthropic from "@anthropic-ai/sdk";

class SourceVerificationAgent {
  constructor(apiKey) {
    this.client = new Anthropic({ apiKey });
    this.tools = [
      {
        name: "search_government_statistics",
        description: "Search official government statistics databases",
        input_schema: {
          type: "object",
          properties: {
            query: { type: "string", description: "Search query" },
            category: { type: "string", description: "Category" }
          },
          required: ["query"]
        }
      }
      // ... other tools
    ];
  }

  async verifyClaim(claim) {
    const messages = [{
      role: "user",
      content: `Verify this claim: "${claim}"`
    }];

    const response = await this.client.messages.create({
      model: "claude-3-5-sonnet-20241022",
      max_tokens: 4096,
      tools: this.tools,
      messages
    });

    // Process response and tool calls...
    return {
      verdict: response.content[0].text,
      evidence: []
    };
  }
}

// Usage
const agent = new SourceVerificationAgent(process.env.ANTHROPIC_API_KEY);
const result = await agent.verifyClaim("Unemployment decreased by 15%");
console.log(result);
```

:::

### Sample Output

```text
=================================================================
CLAIM VERIFICATION REPORT
=================================================================

Claim: Unemployment decreased by 15% in the last quarter

VERDICT: PARTIALLY FALSE - Contains misleading calculation

Analysis:
- Official government statistics show unemployment rate decreased from 5.2% to 4.8%
- This is a 0.4 percentage point decrease
- Percentage-wise, this represents a 7.7% decrease (not 15%)
- The claim appears to confuse percentage points with percentage change

Confidence: HIGH (verified against official sources)

Recommendation: Correct the claim to accurately reflect the 7.7% decrease,
or specify "decreased by 0.4 percentage points"

Sources Checked: 3
1. National Bureau of Statistics (Official Data)
2. Financial Times (Independent Reporting)
3. Reuters (Cross-verification)

Potential Issues:
- Calculation error or intentional misrepresentation
- Confusion between percentage points and percentage change
- Need clarification from claim source
```

## Key Advantages

::: {.callout-tip}
## Benefits of Augmented LLM
1. **Real-time verification**: Access current data, not just training cutoff
2. **Source attribution**: Every claim linked to verifiable source
3. **Structured retrieval**: Systematic search across multiple databases
4. **Audit trail**: Complete log of all sources checked
5. **Scalability**: Verify hundreds of claims per hour
:::

## Limitations & Considerations

::: {.callout-warning}
## Important Limitations
1. **Tool reliability**: Only as good as connected data sources
2. **API costs**: External API calls can be expensive at scale
3. **Latency**: Multiple tool calls add processing time
4. **Tool selection**: Agent must choose appropriate tools
5. **Error handling**: What if tool fails or returns no results?
:::

## Ethical Considerations

### Transparency Requirements

Always disclose:
- Which sources were checked
- What tools were used
- Confidence level in verification
- Any conflicting information found

### Human Oversight

**Required checkpoints:**
- [ ] Verify tool selection was appropriate
- [ ] Review source credibility
- [ ] Check for missing perspectives
- [ ] Validate final conclusion
- [ ] Ensure claim context is preserved

## Hands-On Exercise

Try modifying the code to verify these claims:

1. "GDP grew by 3.5% last quarter"
2. "Crime rates decreased by 20% in major cities"
3. "Education spending increased to record levels"

**Questions to explore:**
- What tools would you need for each claim?
- How would you handle conflicting sources?
- What confidence thresholds would you set?

## Real Newsroom Integration

### Integration Points

```{mermaid}
graph LR
    A[CMS/Editorial System] --> B[Claim Detection]
    B --> C[Augmented LLM Agent]
    C --> D{Verification Result}
    D -->|Verified| E[Proceed to Publish]
    D -->|False| F[Flag for Editor Review]
    D -->|Uncertain| F
    F --> G[Human Fact-Check]
```

### Workflow Considerations

1. **Batch processing**: Verify claims from multiple articles
2. **Priority routing**: Urgent claims → faster, simpler checks
3. **Confidence thresholds**: High confidence → auto-approve; Low → human review
4. **Source diversity**: Require minimum 3 independent sources

## Summary

::: {.callout-note}
## Key Takeaways

**When to use Augmented LLM:**
- Need real-time data beyond training cutoff
- Require source verification and attribution
- Multiple external databases to check
- Structured data retrieval needed

**When NOT to use:**
- Simple factual questions within LLM knowledge
- No reliable external data sources available
- Response time critical (< 5 seconds)
- One-time queries (not worth tool setup)

**Critical success factors:**
- Reliable, credible data sources
- Clear tool selection logic
- Robust error handling
- Human oversight for final decisions
:::

---

**Next**: [Pattern 2: Prompt Chaining →](02-prompt-chaining.qmd)

**Previous**: [← Introduction](00-introduction.qmd)
